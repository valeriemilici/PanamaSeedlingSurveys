---
title: "SeedlingSurveyDataPrep"
author: "Valerie Milici"
date: "5/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Getting Set Up
```{r}
rm(list = ls())
```

Packages used
```{r packages, include=FALSE}
library(tidyverse)
library(spatstat)
```

The data
```{r datasets}
full_data <- read.csv( "Data/TransectData_2018.csv" )

transects<- read.csv(file = "Data/Ch1_Transects_Collated.csv")

seed.mass <- read.csv(file = "Data/Fruit_Seed_masses_20210111.csv")

sp.names <- read.csv(file = "Data/speciescode_Key.csv")

MAP_data <- tibble(Site = c("Met", "Charco", "Oleoducto", "BV", "SLZ"),
                Precip = c(1874, 2050, 2311, 2595, 2848))

Season <- tibble(Transect = 1:50,
                Season = rep(c("Wet", "Dry"), times = c(30, 20)))

dispersal <- read.csv("Data/dispersal_SJW.csv")

adults <- read.csv("Data/siteadults.csv")
```

# Part 1: Creating data of adult locations

Data from CTFS forestGEO database
```{r site data, message=FALSE, warning=FALSE}
elcharco <- read_delim("Data/PlotDataReport02-03-2020_1684784780.txt", delim = "\t")

P06 <- read_delim("Data/PlotDataReport02-03-2020_1727069589.txt", delim = "\t")

P12 <- read_delim("Data/PlotDataReport02-03-2020_1917417786.txt", delim = "\t")

met<-read_delim("Data/PlotDataReport02-03-2020_411730302.txt", delim = "\t")

sherman<- read_delim("Data/PlotDataReport02-03-2020_737920746.txt", delim = "\t")
```

Bind site data
```{r add site column and collate}
elcharco <- elcharco %>% mutate(Site = rep("Charco", length(elcharco$Latin)))

P06 <- P06 %>% mutate(Site = rep("Oleoducto", length(P06$Latin)))

P12<- P12 %>% mutate(Site = rep("BV", length(P12$Latin)))

met<- met %>% mutate(Site = rep("Met", length(met$Latin)))
        
sherman <- sherman %>% filter(Status == "alive") %>% filter(PX <= 100) %>% filter(PY <= 100) %>% 
          mutate(Site = rep("SLZ", 4295))

#adult_data_recent <- rbind(elcharco, P06, P12, met, sherman)
#write.csv(x = adult_data_recent, file = "Data/siteadults.csv")
```

Remove extra columns
```{r clean site data}
adults_recent <- adults %>% dplyr::rename(x = PX, y = PY, sp = Mnemonic) %>%
  subset(select = -c(StemTag, Census, DBH, HOM, Codes, Stem, Status)) %>%
  mutate(site.sp = str_c( Site, sp, sep = "_"))

adult <- adults_recent[!is.na(adults_recent$x) &
                               !is.na(adults_recent$y), ]
```

# Part 2: Preparing Transect Coordinates

Functions to compute coords along transects
```{r transect functions}
x_pts<- function(X1, Angle){
  delta_X<- (1:10)*sin(Angle*pi/180)
  X2<- X1 + delta_X
  return(X2)
}

y_pts<- function(Y1, Angle){
  delta_Y<- (1:10)*cos(Angle*pi/180)
  Y2<- Y1 + delta_Y
  return(Y2)
}

```

Create dataframe of all meters along transects
```{r transect points}
transect_coords <- do.call("rbind", lapply(split(transects, f=transects$Site), function(sdat)
  do.call("rbind", lapply(split(sdat, f=sdat$Transect), function(tdat) 
  {

  xpos <- c(tdat[,3], x_pts(tdat[,3], tdat[,5]))
  ypos <- c(tdat[,4], y_pts(tdat[,4], tdat[,5]))
  
  xpos <- (xpos[-1] + xpos[-11])/2
  ypos <- (ypos[-1] + ypos[-11])/2
  tdat <- data.frame(Site=rep(tdat[,1], 10),
                     Transect=rep(tdat[,2], 10),
                     meter = 1:10,
                     x = xpos,
                     y = ypos)
  }
  ))
))

transect_coords <-data.frame(X = row.names(transect_coords),
                             transect_coords)

```

#Part 2:Species names
```{r species names}

#separate genus and species into two columns
spnames <- select(sp.names, c(1,2,3,5))

#separate column 1 into two columns

gs <- data.frame(str_split_fixed(spnames$Species, " ", 2))

names(gs) <- c("genus", "species")

#merge together

spnames <- cbind(spnames, gs)

spnames <- select(spnames, c(5,6,2,3,4))

names(spnames)[5] <- "Sp"
```

```{r prepping seed mass + dispersal}

sm <- seed.mass %>% select(c(14,22)) %>%
  rename(Sp = sp6) 

sm$Sp <- tolower(sm$Sp)

sm <- na.omit(sm)

sm <- sm %>% group_by(Sp) %>% summarise(seedmass = mean(seed_dry))

disp<- dispersal %>% select(c(2, 7:13)) %>% rename(Sp = code6)

disp$Sp <- tolower(disp$Sp)
```


#Part 3: Cleaning up the data

transect_coords
```{r transect coord cleaning}
# Change Columns in transect_coords so they match column in full_data

transect_coords$X <- gsub( "\\.","_", transect_coords$X )

transect_coords <- transect_coords %>% dplyr::rename( transID = X )
```

full_data

Create a list of spp that are found on at least 3 transects
```{r 3 observation filter}
# Create unique transect IDs 
spp <- mutate( full_data, transID = str_c( Site, Transect, sep = "_" )) %>%

 # Count the number of transects that a species is found on
  group_by( Sp, transID ) %>% 
  count() %>% ungroup() %>% group_by(Sp) %>% count() %>%

# remove species that are on fewer than 3 transects
  filter(n >= 3)
```

Cleaning up the data to only include what will be used in the model
```{r data cleaning}
#Filter full_data so that it only contains rows including spp
#turn on for dataset to analyze distance / density
mod_data <- subset(full_data, Sp %in% spp$Sp) %>%

 #unique seedling by site IDs
  mutate(site.sp = str_c(Site, Sp, sep = "_")) %>%
  
  #unique transect IDs
  mutate(transID = str_c(Site, Transect, Meter, sep="_")) %>%
  
  #remove rows in which no seedlings were observed, and transect in which
  #meter was not accounted for
  filter(Symptomatic != "na") %>%
  
  #MAP_data
  merge(MAP_data, by = "Site") %>%
  
  #Season
  merge(Season, by = "Transect") %>%
  
  #transect location
  merge(transect_coords, by = "transID") %>%
  
  #drop extra columns
  subset(select = -c(Transect.x, Site.x, Notes, X, meter)) %>%
  
  #rename columns
  dplyr::rename(MAP = Precip, Transect = Transect.y, Site = Site.y) #%>%
  
  #rearrange columns
  #select(Site, MAP, Transect, Meter, transID, Season, Date, Family,
         #Genus, Species, Sp, site.sp, x, y, everything())
# Add in Spp info
mod_data <- left_join(mod_data, spnames, by = "Sp")
# Add in Dispersal info
mod_data <- left_join(mod_data, disp, by = "Sp")
# Add in seed mass
mod_data <- left_join(mod_data, sm, by = "Sp")
#Make sure the correct columns are numeric
mod_data <- transform(mod_data, MAP = as.numeric(as.character(MAP)), 
                      Symptomatic = as.numeric(as.character(Symptomatic)), 
                      Asymptomatic = as.numeric(as.character(Asymptomatic)), 
                      N.obs = as.numeric(as.character(N.obs)), 
                      x = as.numeric(as.character(x)),
                      y = as.numeric(as.character(y))) %>%
  
  #add a column for the response (to use in Loo-CV)
  mutate(p.inf = (Symptomatic/N.obs))
```

Add Census # to the data

```{r Census Number}
mod_data$Census <- ifelse(mod_data$Transect <=10, "6", ifelse(between(mod_data$Transect, 11,20), "7",ifelse(between(mod_data$Transect, 21, 30), "8", ifelse(between(mod_data$Transect, 31, 40), "15", ifelse(between(mod_data$Transect, 41,50), "16", "")))))
```

# Part 4: Calculating Distance to adult conspecific and heterospecific

Note: produces warnings for seedlings who did not have a conspecific adult within the 1-ha forest plot. Results in inf values.
```{r adult distances, error=FALSE, message=FALSE, warning=FALSE}
closest_adult<- vector()
mod_data$closest_adult<- NA
a<- vector()

for (i in 1:nrow(mod_data)) {
  
  a<- adult[which(as.character(adult$site.sp) == as.character(mod_data$site.sp[i])),]
  
  closest_adult <- min(crossdist.default(mod_data$x[i], mod_data$y[i], a$x, a$y))
  
  mod_data$closest_adult[i]<- closest_adult
}

closest_het<- vector()
mod_data$closest_het <- NA
b <- vector()

for (i in 1:nrow(mod_data)) {
  
  b <- adult[which(as.character(adult$site.sp) != as.character(mod_data$site.sp[i])),]
  
  closest_het <- min(crossdist.default(mod_data$x[i], mod_data$y[i], b$x, b$y))
  
  mod_data$closest_het[i]<- closest_het
}
```

Convert to proximity
```{r adult proximity}
mod_data<- mutate(mod_data, prox = 1/closest_adult)
  
mod_data <- mutate(mod_data, prox.h = 1/closest_het)
```

#Part 5: Add in heterospecifics 

##Add in general column for heterospecific density
```{r het density}
data.1 <- aggregate(N.obs ~ transID, data = mod_data, FUN = sum) %>%
    dplyr::rename(total.dens = N.obs) %>%
    merge(mod_data, by = "transID") %>%
    mutate(het.dens = (total.dens - N.obs))
```

Add counts for how many seedlings of each species were observed
```{r number of seedling observations}
abundance <- aggregate(N.obs ~ Sp, data = data.1, FUN = sum) %>%
  dplyr::rename(abund = N.obs)


newdat <- merge(data.1, abundance, by = "Sp") %>%
  mutate(species_abund = paste0(Sp, "(", abund ,")"))


```

Basal Area as another method for common vs rare
```{r basal area of adults at each site}

met.BA <- mutate(met, "BA" = (pi*(DBH/2)^2)) %>% group_by(Mnemonic) %>%
  summarise(sumBA = sum(BA)) %>% mutate("Site" = "Met")
elcharco.BA<- mutate(elcharco, "BA" = (pi*(DBH/2)^2)) %>% group_by(Mnemonic) %>%
  summarise(sumBA = sum(BA))  %>% mutate("Site" = "Charco")
P06.BA <- mutate(P06, "BA" = (pi*(DBH/2)^2))  %>% group_by(Mnemonic) %>%
  summarise(sumBA = sum(BA))  %>% mutate("Site" = "Oleoducto")
BV.BA <- mutate(P12, "BA" = (pi*(DBH/2)^2)) %>% group_by(Mnemonic) %>%
  summarise(sumBA = sum(BA)) %>% mutate("Site" = "BV")
sherman.BA <- mutate(sherman, "BA" = (pi*(DBH/2)^2)) %>% group_by(Mnemonic) %>%
  summarise(sumBA = sum(BA)) %>% mutate("Site" = "SLZ")

all.BA <- rbind(met.BA, elcharco.BA, P06.BA, BV.BA, sherman.BA)

names(all.BA)[1] <- "Sp"

dat.BA <- left_join(newdat, all.BA, by = c("Site", "Sp"))
```

```{r remove shrubs and probably lianas}

shrubs <- c("1-27", "1-4", "1-5", "cappin", "pipeco", "pipere", "pipersp", "psycde",
            "psycma", "psycsp")

dat.BA <- filter(dat.BA, !(Sp %in% shrubs))

```



Save it as a CSV
```{r write csv}
write.csv(dat.BA, "Data/mod_data_2.csv")
```

